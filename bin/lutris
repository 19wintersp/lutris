#!/usr/bin/python2
# -*- Mode: Python; coding: utf-8; indent-tabs-mode: nil; tab-width: 4 -*-
# Copyright (C) 2010 Mathieu Comandon <strycore@gmail.com>
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 3, as published
# by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranties of
# MERCHANTABILITY, SATISFACTORY QUALITY, or FITNESS FOR A PARTICULAR
# PURPOSE.  See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program.  If not, see <http://www.gnu.org/licenses/>.

"""Program entry point"""

import os
import sys
import logging
import optparse
import signal

# pylint: disable=E0611
from gi.repository import Gtk

from os.path import realpath, dirname, normpath

LAUNCH_PATH = dirname(realpath(__file__))
if LAUNCH_PATH != "/usr/bin":
    SOURCE_PATH = normpath(os.path.join(LAUNCH_PATH, '..'))
    sys.path.insert(0, SOURCE_PATH)

from lutris.gui.dialogs import QuestionDialog

try:
    import yaml as _yaml
except ImportError:
    q = QuestionDialog({'title': "Dependency not available",
                        'question': "PythonYAML is not installed,\n"
                                    "do you want to install it now?"})
    if q.result == Gtk.ResponseType.YES:
        os.system('software-center python-yaml')
    else:
        sys.exit()

from lutris.constants import CONFIG_EXTENSION, GAME_CONFIG_PATH
from lutris.util.log import logger
from lutris.installer import Installer
from lutris.config import check_config
from lutris.pga import get_games
from lutris.gui.lutriswindow import LutrisWindow


# Support for command line options.
parser = optparse.OptionParser(version="%prog %ver")
parser.add_option("-v", "--verbose", action="store_true",
                  dest="verbose", help="Verbose output")
parser.add_option("-d", "--debug", action="store_true",
                  dest="debug", help="Show debug messages")
parser.add_option("-i", "--install", dest="installer_file",
                  help="Install a game from a yml file")
parser.add_option("-l", "--list-games", action="store_true",
                  help="List all games in database")
parser.add_option("-f", "--force-install", action="store_true",
                  help="Force installation even if game is installed")
parser.add_option("-n", "--no-download",
                  action="store_true", dest="no_download",
                  help="Don't download anything when installing")
(options, args) = parser.parse_args()

# Set the logging level to show debug messages.
console = logging.StreamHandler()
fmt = '%(name)-12s: %(levelname)-8s %(message)s'
formatter = logging.Formatter(fmt)
console.setFormatter(formatter)
logger.addHandler(console)
logger.setLevel(logging.ERROR)

if options.verbose:
    logger.info("Verbose mode enabled")
    logger.setLevel(logging.INFO)
if options.debug:
    logger.setLevel(logging.DEBUG)
    logger.debug('logging enabled')
if options.list_games:
    print get_games()
    exit()

check_config(force_wipe=False)

installer = False
game = None
if options.installer_file:
    if not os.path.exists(options.installer_file):
        logger.error("Unable to find installer at : %s",
                     options.installer_file)
        exit()
    else:
        game, _ext = os.path.splitext(options.installer_file)
        installer = os.path.abspath(options.installer_file)
        logger.info("Installing game from %s" % installer)


# Run the application.
signal.signal(signal.SIGINT, signal.SIG_DFL)
for arg in args:
    if arg.startswith('lutris:'):
        game = arg[7:]
        break

if game:
    file_path = os.path.join(GAME_CONFIG_PATH, game + CONFIG_EXTENSION)
    if os.path.exists(file_path) and not options.force_install:
        import lutris.game
        logger.info('Launching ' + game)
        lutris_game = lutris.game.LutrisGame(game)
        lutris_game.play()
    else:
        logger.debug('Installing %s' % game)
        installer = Installer(game, installer)
        Gtk.main()
else:
    lutris_window = LutrisWindow()

    Gtk.main()
    logger.debug("Application exit")
